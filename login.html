<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Login</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --danger: #ef4444;
      --shadow: 0 10px 40px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji", "Segoe UI Symbol";
      background-image:
        linear-gradient(135deg, rgba(6, 11, 25, 0.85), rgba(15, 23, 42, 0.9)),
        url('images/login_background.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
    }

    .login-container {
      width: min(360px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)), var(--card);
      border: 1px solid #1f2937;
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 32px;
      display: grid;
      gap: 18px;
    }

    h2 {
      margin: 0;
      text-align: center;
      font-size: 1.5rem;
    }

    label {
      font-size: 0.9rem;
      color: var(--muted);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      font-size: 1rem;
    }

    button[type="submit"] {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #062a3a;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(56, 189, 248, 0.35);
    }

    button[type="submit"]:active { transform: translateY(1px); }

    .error {
      color: var(--danger);
      font-size: 0.9rem;
      min-height: 1.2rem;
      text-align: center;
    }

    .helper {
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h2>Secure Update Access</h2>
    <form id="loginForm" autocomplete="off">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required placeholder="Admin">

      <label for="password">Password</label>
      <input type="password" id="password" name="password" required placeholder="••••••••">

      <button type="submit">Continue</button>
    </form>
    <p class="error" id="loginError" role="alert"></p>
    <p class="helper">Use your Login account.</p> 
  </div>
  <script>
    (async function () {
      const USERS_KEY = 'projectDashboardAccounts';
      const DEFAULT_SECRET_HASH = '3a6ae36613f5be90056a9419e62f759145ba372808045f7ec0c457ea4a3fd3ad';
      const AUTH_KEY = 'projectDashboardAuth';
      const WELCOME_KEY = 'projectDashboardWelcomeName';
      const ACTIVE_USER_KEY = 'projectDashboardActiveUser';

      const params = new URLSearchParams(window.location.search);
      const redirectParam = params.get('redirect');
      const redirectTarget = redirectParam ? decodeURIComponent(redirectParam) : 'user_index.html';

      const form = document.getElementById('loginForm');
      const errorEl = document.getElementById('loginError');

      const toHex = (buffer) => Array.from(new Uint8Array(buffer)).map((byte) => byte.toString(16).padStart(2, '0')).join('');

      const fallbackHash = (value = '') => {
        let hash = 0;
        for (let i = 0; i < value.length; i += 1) {
          hash = ((hash << 5) - hash) + value.charCodeAt(i);
          hash |= 0;
        }
        return hash.toString(16);
      };

      const digestText = async (value = '') => {
        if (window.crypto && window.crypto.subtle && window.TextEncoder) {
          const encoder = new TextEncoder();
          const data = encoder.encode(value);
          const hash = await window.crypto.subtle.digest('SHA-256', data);
          return toHex(hash);
        }
        return fallbackHash(value);
      };

      const normalizeUsername = (value = '') => value.trim().toLowerCase();
      const buildSecretHash = (username, password) => digestText(`${normalizeUsername(username)}:${password}`);

      const loadAccounts = () => {
        try {
          const raw = window.localStorage && window.localStorage.getItem(USERS_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          return [];
        }
      };

      const saveAccounts = (accounts) => {
        try {
          window.localStorage && window.localStorage.setItem(USERS_KEY, JSON.stringify(accounts));
        } catch (error) {
          // ignore persistence issues
        }
      };

      const sanitizeAccounts = async (records) => {
        let changed = false;
        const sanitized = [];
        for (const record of records) {
          const username = (record?.username || '').trim();
          if (!username) { continue; }
          if (record.system) {
            changed = true;
            continue;
          }
          if (record.secretHash) {
            sanitized.push({ username, secretHash: record.secretHash });
            continue;
          }
          if (record.password) {
            const secretHash = await buildSecretHash(username, record.password);
            sanitized.push({ username, secretHash });
            changed = true;
          }
        }
        if (changed) {
          saveAccounts(sanitized);
        }
        return sanitized;
      };

      const persistAuth = () => {
        try {
          if (window.localStorage) {
            window.localStorage.setItem(AUTH_KEY, 'granted');
          }
          if (window.sessionStorage) {
            window.sessionStorage.setItem(AUTH_KEY, 'granted');
          }
        } catch (error) {
          // ignore storage failures
        }
      };

      const persistActiveUser = (username) => {
        try {
          if (window.localStorage) {
            window.localStorage.setItem(ACTIVE_USER_KEY, username);
          }
          if (window.sessionStorage) {
            window.sessionStorage.setItem(ACTIVE_USER_KEY, username);
          }
        } catch (error) {
          // ignore storage failures
        }
      };

      const persistWelcome = (username) => {
        try {
          window.sessionStorage && window.sessionStorage.setItem(WELCOME_KEY, username);
        } catch (error) {
          // ignore session storage failures
        }
      };

      let accounts = await sanitizeAccounts(loadAccounts());

      const refreshAccounts = async () => {
        accounts = await sanitizeAccounts(loadAccounts());
      };

      const verifyCredentials = async (username, password) => {
        const secretHash = await buildSecretHash(username, password);
        const normalized = normalizeUsername(username);
        const match = accounts.find((account) => account.username && normalizeUsername(account.username) === normalized && account.secretHash === secretHash);
        if (match) {
          return { ok: true, name: match.username };
        }
        if (secretHash === DEFAULT_SECRET_HASH) {
          return { ok: true, name: username || 'System Admin' };
        }
        return { ok: false };
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        errorEl.textContent = '';
        await refreshAccounts();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
          errorEl.textContent = 'Enter both a username and password.';
          return;
        }

        const result = await verifyCredentials(username, password);

        if (result.ok) {
          persistAuth();
          persistWelcome(result.name);
          persistActiveUser(result.name);
          window.location.href = redirectTarget;
        } else {
          errorEl.textContent = 'Invalid credentials. Try again or create a new account from Add user account.';
        }
      });
    })();
  </script>
</body>
</html>